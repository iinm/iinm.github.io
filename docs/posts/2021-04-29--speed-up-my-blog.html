<!DOCTYPE html><html lang="ja"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/8685693?s=48" type="image/x-icon">
    <link rel="stylesheet" href="../site.css" type="text/css" media="all">
    <link rel="stylesheet" href="page.css" type="text/css" media="all">
    <title>このブログの表示速度改善</title>
  </head>
  <body>
    <nav>
      <div class="navigation">
        <img class="navigation__icon" src="https://avatars.githubusercontent.com/u/8685693?s=128" alt="">
        <a class="navigation__link" href="..">back to index</a>
      </div>
    </nav>
    <section class="post"><div class="post__date"><time datetime="2021-04-29">2021-04-29</time></div><h1>このブログの表示速度改善</h1><h2>サマリー</h2><p>簡素なサイトなので油断していたが、表示速度を改善する余地があったためいくつか対策した。</p><ul><li>Webフォントをやめて、各種OSで利用できるフォントを指定</li><li>直列だったCSS、JavaScriptのGETを並列化</li><li>コンテンツをPrefetch</li><li>(おまけ) コンテンツのfetch中にローディング画面を表示して、白い画面が表示されることを防いだ。</li></ul><h2>改善前</h2><p><div class="image-link"><a href="https://user-images.githubusercontent.com/8685693/153013157-8669c86c-6e3f-49a5-a792-f35229a878fe.png" target="_blank" rel="noopener"><img alt="" src="https://user-images.githubusercontent.com/8685693/153013157-8669c86c-6e3f-49a5-a792-f35229a878fe.png" loading="lazy"></a></div></p><p>Developer toolsで通信内容を確認すると以下のことがわかります。</p><ul><li>通信サイズの大半がWebフォント。通信量、回数ともに多い。</li><li>page.css, site.cssを直列でGETしている。</li><li>main.js, markdown.js, .mdを直列でGETしている。</li></ul><h2>Step 1: Webフォントをやめる</h2><p>OSによって利用できるフォントが異なることにより、本文とコードブロックのフォントサイズのバランス等 が崩れることを懸念してWebフォントを指定していました。 しかし、想定以上にサイズが大きかったため諦めて各OSで利用できるフォントの指定に変更しました。 ※ Androidには明朝体が入っていないためゴシック体で表示されます。</p><p>before:</p><div class="code-block__language-label">css</div><pre><code>@import url('https://fonts.googleapis.com/css2?family=Lora&amp;family=Ubuntu+Mono&amp;family=Shippori+Mincho:wght@500&amp;display=swap');

body {
  font-family: 'Lora', 'Shippori Mincho', serif;
  ...
}</code></pre><p>after:</p><div class="code-block__language-label">css</div><pre><code>body {
  font-family:
  'Noto Serif CJK JP',    /* for Ubuntu */
  'Hiragino Mincho ProN', /* for macOS */
  'Yu Mincho',            /* for Windows */
  serif
  ;</code></pre><h2>Step 2: CSS, JavaScriptを並列でGETする</h2><p>before: サイト全体に適用したい<code>site.css</code>とページ固有の<code>page.css</code>に分け、<code>page.css</code>から<code>site.css</code>をimportしていましたが、これではCSSのGETリクエストが直列になってしまいます。</p><div class="code-block__language-label">css</div><pre><code>/* page.css */
@import '../site.css';</code></pre><p>after: importではなく、linkタグで読み込むように変更しました。</p><div class="code-block__language-label">html</div><pre><code>&lt;!-- posts/index.html --&gt;
&lt;link rel="stylesheet" href="/site.css" type="text/css" media="all"&gt;
&lt;link rel="stylesheet" href="page.css" type="text/css" media="all"&gt;</code></pre><p>JavaScript Modulesも同様です。コンテンツ(Markdown)のfetchとレンダリングをする<code>main.js</code>とMarkdownを処理する <code>markdown.js</code>に分けていて、<code>main.js</code>から<code>markdown.js</code>をimportしていたため、JavaScriptファイルのGET リクエストが直列になっていました。</p><p>before:</p><div class="code-block__language-label">javascript</div><pre><code>// posts/main.js
import * as markdown from '/modules/markdown.js'</code></pre><p>after: <code>index.html</code>でまとめてimport、dependency injection風に依存moduleを渡すように書き換えました。 （この方法ではModuleが増えると破綻しそうですね。）</p><p>※ <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Link_types/modulepreload">modulepreload</a>という仕組みもありますが、画面のレンダリングがブロックされて白い画面が表示される時間が長くなってしまったため今回は利用しませんでした。</p><div class="code-block__language-label">html</div><pre><code>&lt;!-- posts/index.html --&gt;
&lt;script type="module"&gt;
  import * as markdown from '/modules/markdown.js'
  import * as main from './main.js'
  window.onload = () =&gt; main.render({ modules: { markdown } })
&lt;/script&gt;</code></pre><p>ここまでの修正でCSSファイル2つ、JavaScriptファイル2つを並列でGETするようになりました。</p><p><div class="image-link"><a href="https://user-images.githubusercontent.com/8685693/153013170-8d748514-ad69-4600-ad10-1b4166585457.png" target="_blank" rel="noopener"><img alt="" src="https://user-images.githubusercontent.com/8685693/153013170-8d748514-ad69-4600-ad10-1b4166585457.png" loading="lazy"></a></div></p><h2>Step 3: インデックスページで最新の記事をPrefetchする</h2><p>Query stringからMarkdownファイルのURLを組み立てているため、 JavaScriptとMarkdownのGETリクエストはどうしても直列になってしまいます。 インデックスページで最新の記事をprefetchするよう設定しました。</p><p>※ 2021-04-29時点でSafariではサポートしていません。また、この方法でJavaScript ModulesをPrefetchすることはできません。 参考：<a href="https://developers.google.com/web/updates/2017/12/modulepreload">Preloading modules</a></p><div class="code-block__language-label">html</div><pre><code>&lt;! -- index.html --&gt;
&lt;!-- Prefetch latest post --&gt;
&lt;link rel="prefetch" href="posts/?post=2021-04-24--markdown-to-html"&gt;
&lt;link rel="prefetch" href="posts/2021-04-24--markdown-to-html.md"&gt;</code></pre><p>結果、Markdownファイルのfetch時間がほぼなくなりました。</p><p><div class="image-link"><a href="https://user-images.githubusercontent.com/8685693/153013178-4d4b1787-ad1f-421f-97ec-2fa3984ba81a.png" target="_blank" rel="noopener"><img alt="" src="https://user-images.githubusercontent.com/8685693/153013178-4d4b1787-ad1f-421f-97ec-2fa3984ba81a.png" loading="lazy"></a></div></p><h2>おまけ: ローディング画面を表示して、白い画面が表示される時間を短くする</h2><p>このブログの作り上、Prefetchできない状況ではMarkdownファイルをfetchするまで白い画面が表示されてしまいます。 読み込み中であることが分かるようにローディング画面を表示するように修正しました。</p><p>before:</p><p><div class="image-link"><a href="https://user-images.githubusercontent.com/8685693/153013174-4e5f77a6-2029-40ab-ab1f-3c6609eee953.gif" target="_blank" rel="noopener"><img alt="" src="https://user-images.githubusercontent.com/8685693/153013174-4e5f77a6-2029-40ab-ab1f-3c6609eee953.gif" loading="lazy"></a></div></p><p>after:</p><p><div class="image-link"><a href="https://user-images.githubusercontent.com/8685693/153013167-d3b47a07-e280-40fe-8833-8e5a38431de8.gif" target="_blank" rel="noopener"><img alt="" src="https://user-images.githubusercontent.com/8685693/153013167-d3b47a07-e280-40fe-8833-8e5a38431de8.gif" loading="lazy"></a></div></p><h2>今後の課題</h2><ul><li>JavaScript Modulesの使い方改善: 結果的にDepedency Indejction風になりテストが書きやすそうな形になったものの、Moduleが増えて依存関係が複雑になると煩雑になることが見えている。（Bundler使おうな！って結論になるかもしれない）</li><li>modulepreloadの挙動確認: 今回は白い画面が表示される時間が長くなってしまったため使わなかったが、使い方を間違えただけかもしれないのでもう一度調べる。</li><li>Service workerの利用: 他のサイトではService workerを使ってリソースをprefetchしていた。このブログでも使えないか？</li></ul></section>
  

</body></html>